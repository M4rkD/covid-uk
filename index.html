<?xml version="1.0" encoding="utf-8"?>
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-05-22 Fri 21:03 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UK.R</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="mark" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<style> .src-R { background: #f5fbff; } .src-org { background: #effef2; } </style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.cacheClassElem = elem.className;
         elem.cacheClassTarget = target.className;
         target.className = "code-highlighted";
         elem.className   = "code-highlighted";
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(elem.cacheClassElem)
         elem.className = elem.cacheClassElem;
       if(elem.cacheClassTarget)
         target.className = elem.cacheClassTarget;
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">UK.R</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgc406a0a">1. Disclaimer</a></li>
<li><a href="#org7997f80">2. Approach</a></li>
<li><a href="#orgbc56d11">3. UK.R Walkthrough</a>
<ul>
<li><a href="#org090f25d">3.1. Setup</a></li>
<li><a href="#orgf368307">3.2. Locations</a></li>
</ul>
</li>
<li><a href="#orgfeff298">4. UK Parameters</a>
<ul>
<li><a href="#org187b011">4.1. Contact Matrices:</a></li>
</ul>
</li>
<li><a href="#org5921cdb">5. UK Regions</a>
<ul>
<li><a href="#org2a979c8">5.1. Regional parameter setup</a></li>
<li><a href="#org7aaadfb">5.2. Split matrices.</a></li>
<li><a href="#orgb7797d2">5.3. Aggregate function</a>
<ul>
<li><a href="#org4ae1cf6">5.3.1. Collect functions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc52dfdf">6. Main</a></li>
<li><a href="#org44625a1">7. Start Runs</a>
<ul>
<li><a href="#org5644f51">7.1. Base simulation</a>
<ul>
<li><a href="#orgd375d0a">7.1.1. Run &ldquo;base&rdquo; simulation</a></li>
<li><a href="#org6d8b8a7">7.1.2. Interventions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orga56acdd">8. Appendix</a>
<ul>
<li><a href="#org25b14fe">8.1. Regions/Locations</a>
<ul>
<li><a href="#orgcce0198">8.1.1. level 0</a></li>
<li><a href="#org69b5507">8.1.2. level 1</a></li>
<li><a href="#org8a56064">8.1.3. level 2</a></li>
<li><a href="#orgc0b4ba8">8.1.4. level 3</a></li>
<li><a href="#orgeea4fe2">8.1.5. level 4</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgc406a0a" class="outline-2">
<h2 id="orgc406a0a"><span class="section-number-2">1</span> Disclaimer</h2>
<div class="outline-text-2" id="text-1">
<p>
<b>This is an exploratory document, and highly likely to contain omissions and/or errors. Please verify any and all information you find here yourself, as I give absolutely no guarantee that any of it is correct.</b>
</p>
</div>
</div>
<div id="outline-container-org7997f80" class="outline-2">
<h2 id="org7997f80"><span class="section-number-2">2</span> Approach</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Treat C++ code as a black box for config</li>
<li>Understand &ldquo;configuration&rdquo; via R script</li>
<li>Focus only/mainly on performance of C++ code</li>
<li>Understand mechanics of configuration</li>
<li>Still have open questions</li>
</ul>
</div>
</div>

<div id="outline-container-orgbc56d11" class="outline-2">
<h2 id="orgbc56d11"><span class="section-number-2">3</span> UK.R Walkthrough</h2>
<div class="outline-text-2" id="text-3">
<p>
This section walks through the UK.R, showing clip of each section and the resulting data structures.
</p>

<p>
This done for a hypothetical simulation, for a single iteration of the loop over 1:n<sub>runs</sub>. It doesn&rsquo;t reflect exactly values from any particular analysis, but rather shows typical data structures in use.
</p>
</div>

<div id="outline-container-org090f25d" class="outline-3">
<h3 id="org090f25d"><span class="section-number-3">3.1</span> Setup</h3>
<div class="outline-text-3" id="text-3-1">
<p>
The first section of the code consists of setup, reading parameters and importing libraries.
</p>

<p>
First, import some libraries:
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #b751b6;">library</span>(rlang)
<span style="color: #b751b6;">library</span>(reshape2)
<span style="color: #b751b6;">library</span>(stringr)
<span style="color: #b751b6;">library</span>(rprojroot)
<span style="color: #b751b6;">library</span>(tibble)
</pre>
</div>

<p>
Next, some setup of directories, sourcing code and building. The variable <code>covid_uk_path</code> is used to determine the directory for inputs, outputs and build products.
</p>

<p>
somicroso
The source call includes another file. In this csae covidm.R.
</p>

<p>
also causes the underlying C++ code to be compiled if it isn&rsquo;t already compiled.
</p>
<div class="org-src-container">
<pre class="src src-R">covid_uk_path = getwd()
cm_path = file.path(covid_uk_path, <span style="color: #50a14f;">"covidm"</span>);
<span style="color: #b751b6;">source</span>(file.path(cm_path, <span style="color: #50a14f;">"R/covidm.R"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf368307" class="outline-3">
<h3 id="orgf368307"><span class="section-number-3">3.2</span> Locations</h3>
<div class="outline-text-3" id="text-3-2">
<p>
The granularity of simulation is controlled by a list of &ldquo;locations&rdquo; or regions to simluate
over. Simulation over each region is for the most part an independent simulation, each region is an independent &ldquo;population&rdquo;.
</p>

<p>
A list of regions is generated from data by calling <code>cm_uk_locations</code>, for example:
</p>

<div class="org-src-container">
<pre class="src src-R">cm_uk_locations(<span style="color: #50a14f;">"UK"</span>, <span style="color: #da8548; font-weight: bold;">1</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">UK | ENGLAND
UK | WALES
UK | SCOTLAND
UK | NORTHERN IRELAND
</pre>
</div>

<p>
The granularity of the regions is controlled by the second argument to <code>cm_uk_locations</code>.
Lists of regions can be found in the appendix. The number of regions in each
level is given by:
</p>

<div class="org-src-container">
<pre class="src src-org">level  0  =  1 regions
level  1  =  4 regions
level  2  =  12 regions
level  3  =  186 regions
level  4  =  382 regions
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfeff298" class="outline-2">
<h2 id="orgfeff298"><span class="section-number-2">4</span> UK Parameters</h2>
<div class="outline-text-2" id="text-4">
<p>
Build parameters. This includes a population matrix for each of the locations.
constructed using dE, dIp, dIs, dIa etc.
</p>

<p>
Deterministic is a flag that&rsquo;s set in the output data structure.
</p>
<div class="org-src-container">
<pre class="src src-R">parametersUK1 = cm_parameters_SEI3R(cm_uk_locations(<span style="color: #50a14f;">"UK"</span>, <span style="color: #da8548; font-weight: bold;">0</span>),
    dE  = cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">4.0</span>, <span style="color: #da8548; font-weight: bold;">4.0</span>, t_max = <span style="color: #da8548; font-weight: bold;">60</span>, t_step = <span style="color: #da8548; font-weight: bold;">0.25</span>)$p,
    dIp = cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">1.5</span>, <span style="color: #da8548; font-weight: bold;">4.0</span>, t_max = <span style="color: #da8548; font-weight: bold;">60</span>, t_step = <span style="color: #da8548; font-weight: bold;">0.25</span>)$p,
    dIs = cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">3.5</span>, <span style="color: #da8548; font-weight: bold;">4.0</span>, t_max = <span style="color: #da8548; font-weight: bold;">60</span>, t_step = <span style="color: #da8548; font-weight: bold;">0.25</span>)$p,
    dIa = cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">5.0</span>, <span style="color: #da8548; font-weight: bold;">4.0</span>, t_max = <span style="color: #da8548; font-weight: bold;">60</span>, t_step = <span style="color: #da8548; font-weight: bold;">0.25</span>)$p,
    deterministic = F);
</pre>
</div>

<p>
<code>cm_delay_gamma</code> returns 241 entries. Presumably one per time step (60*4 = 240).
</p>
<div class="org-src-container">
<pre class="src src-R">summary(cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">4.0</span>, <span style="color: #da8548; font-weight: bold;">4.0</span>, t_max = <span style="color: #da8548; font-weight: bold;">60</span>, t_step = <span style="color: #da8548; font-weight: bold;">0.25</span>)$p)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">     Min.   1st Qu.    Median      Mean   3rd Qu.      Max.
0.000e+00 0.000e+00 0.000e+00 4.149e-03 3.526e-05 5.596e-02
</pre>
</div>

<p>
The $matrices entry is the same for each population. It&rsquo;s read from a file (<code>all_matrices.rds</code>).
</p>

<p>
This file contains data for 617 countries, each with a contact matrix
that looks like:
</p>
<div class="org-src-container">
<pre class="src src-org">List of 4
 $ home  : num [1:18, 1:18] 0.2464 0.1514 0.0509 0.0702 0.0861 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$                  : chr [1:18] "0-4" "5-9" "10-14" "15-19" ...
  .. ..$ contact.age.group: chr [1:18] "0-4" "5-9" "10-14" "15-19" ...
 $ work  : num [1:18, 1:18] 0.02899 0 0 0 0.00702 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$                  : chr [1:18] "0-4" "5-9" "10-14" "15-19" ...
  .. ..$ contact.age.group: chr [1:18] "0-4" "5-9" "10-14" "15-19" ...
 $ school: num [1:18, 1:18] 1.27536 0.04002 0 0.00985 0.08422 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$                  : chr [1:18] "0-4" "5-9" "10-14" "15-19" ...
  .. ..$ contact.age.group: chr [1:18] "0-4" "5-9" "10-14" "15-19" ...
 $ other : num [1:18, 1:18] 0.3333 0.228 0.0325 0.0492 0.0334 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$                  : chr [1:18] "0-4" "5-9" "10-14" "15-19" ...
  .. ..$ contact.age.group: chr [1:18] "0-4" "5-9" "10-14" "15-19" ...
</pre>
</div>

<p>
There are 18 age ranges:
</p>
<div class="org-src-container">
<pre class="src src-org">0-4
5-9
10-14
15-19
20-24
25-29
30-34
35-39
40-44
45-49
50-54
55-59
60-64
65-69
70-74
75-79
80-84
85+
</pre>
</div>

<p>
<code>cm_demographics</code> input data is used to compute population size, as (m + f) * 1000*
</p>
<div class="org-src-container">
<pre class="src src-org">Classes &#8216;data.table&#8217; and 'data.frame':  13684 obs. of  6 variables:
 $ country_code : num  900 900 900 900 900 900 900 900 900 900 ...
 $ name         : Factor w/ 715 levels "Afghanistan",..: 245 245 245 245 245 245 245 245 245 245 ...
 $ age          : Factor w/ 23 levels "0-4","5-9","10-14",..: 1 2 3 4 5 6 7 8 9 10 ...
 $ f            : num  328509 321512 309770 295554 289101 ...
 $ m            : num  349433 342928 331497 316642 308287 ...
 $ location_type: num  0 0 0 0 0 0 0 0 0 0 ...
 <span style="color: #4078f2;">-</span> attr(*, ".internal.selfref")=&lt;
</pre>
</div>

<p>
It seems that most of <code>cm_parameters_SEI3R</code> is mainly loading existing data and
setting variables.
</p>

<div class="org-src-container">
<pre class="src src-R">print_params(parametersUK1, <span style="color: #da8548; font-weight: bold;">1</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Duration fields:
 date0 : 2020-03-01
 time0 : 0
 time1 : 2021-03-01
 time_step : 0.25


Behavioural flag fields
 fast_multinomial : NA
 deterministric : NA


Populations [1]:
UK | UNITED KINGDOM
</pre>
</div>

<p>
Comments, from further down the script, on the same parameters:
</p>
<ul class="org-ul">
<li>dE  = 6.5 day serial interval.</li>
<li>dIp = 1.5 days w/o symptoms</li>
<li>dIs = 5 days total of infectiousness</li>
<li>dIa = 5 days total of infectiousness here as well.</li>
</ul>

<div class="org-src-container">
<pre class="src src-org">  type           : chr "SEI3R"
  dE             : num [1:241] 9.21e-06 6.02e-04 3.27e-03 8.38e-03 1.54e-02 ...
  dIp            : num [1:241] 0.000395 0.018594 0.069279 0.119197 0.145304 ...
  dIa            : num [1:241] 3.85e-06 2.62e-04 1.49e-03 4.00e-03 7.71e-03 ...
  dIs            : num [1:241] 1.55e-05 9.85e-04 5.17e-03 1.28e-02 2.27e-02 ...
  dH             : num 1
  dC             : num 1
  size           : num [1:16] 3914028 4138524 3858894 3669250 4184575 ...
  matrices       :List of 4
  contact        : num [1:4] 1 1 1 1
  contact_mult   : num(0)
  contact_lowerto: num(0)
  u              : num [1:16] 0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.08 ...
  y              : num [1:16] 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 ...
  fIp            : num [1:16] 1 1 1 1 1 1 1 1 1 1 ...
  fIs            : num [1:16] 1 1 1 1 1 1 1 1 1 1 ...
  fIa            : num [1:16] 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 ...
  rho            : num [1:16] 1 1 1 1 1 1 1 1 1 1 ...
  tau            : num [1:16] 1 1 1 1 1 1 1 1 1 1 ...
  seed_times     : num 1
  dist_seed_ages : num [1:16] 1 1 1 1 1 1 1 1 1 1 ...
  schedule       : list()
  observer       : NULL
  name           : chr "UK | UNITED KINGDOM"
  group_names    : chr [1:16] "0-4" "5-9" "10-14" "15-19" ...
</pre>
</div>
</div>

<div id="outline-container-org187b011" class="outline-3">
<h3 id="org187b011"><span class="section-number-3">4.1</span> Contact Matrices:</h3>
<div class="outline-text-3" id="text-4-1">

<div class="figure">
<p><img src="1-home.png" alt="1-home.png" />
</p>
</div>

<p>
The parameters for a &ldquo;generic&rdquo; simulation.
</p>

<ul class="org-ul">
<li>date0, time0, time1 : time range of simulation (note: time1 is a date)</li>
<li><code>time_step</code> : steps to take (presumably in the simulation units, which are days)</li>
<li><code>report_every</code> - appears to record or set every <code>report_every</code> timesteps</li>
<li><code>fast_multinomial</code> : choose which implementation of multinomial solution to use</li>
<li>deterministric : skips some seeding in time marching.</li>
<li><p>
pop: populations, just one population (whole UK) in this case
</p>

<div class="org-src-container">
<pre class="src src-R">matrix_summary(parametersUK1$pop[[<span style="color: #da8548; font-weight: bold;">1</span>]]$matrices)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"> [1] "home"
       0-4              5-9              10-14             15-19            20-24             25-29             30-34             35-39             40-44             45-49             50-54             55-59             60-64             65-69             70-74

  Min.   :0.0544   Min.   :0.05793   Min.   :0.06102   Min.   :0.1091   Min.   :0.03363   Min.   :0.01391   Min.   :0.02288   Min.   :0.06115   Min.   :0.07232   Min.   :0.09259   Min.   :0.04746   Min.   :0.01223   Min.   :0.02017   Min.   :0.01140   Min.   :0.009259   Min.   :0.01695
  1st Qu.:0.1621   1st Qu.:0.16038   1st Qu.:0.15109   1st Qu.:0.1557   1st Qu.:0.10215   1st Qu.:0.11785   1st Qu.:0.14453   1st Qu.:0.12816   1st Qu.:0.14598   1st Qu.:0.11999   1st Qu.:0.15631   1st Qu.:0.11726   1st Qu.:0.11943   1st Qu.:0.06594   1st Qu.:0.044178   1st Qu.:0.10271
  Median :0.1938   Median :0.24352   Median :0.23989   Median :0.2279   Median :0.17053   Median :0.18279   Median :0.17433   Median :0.24596   Median :0.22837   Median :0.16648   Median :0.17679   Median :0.18131   Median :0.15578   Median :0.12663   Median :0.108972   Median :0.15005
  Mean   :0.2587   Mean   :0.36008   Mean   :0.32720   Mean   :0.3093   Mean   :0.23209   Mean   :0.22059   Mean   :0.26362   Mean   :0.29457   Mean   :0.27971   Mean   :0.22727   Mean   :0.19393   Mean   :0.18164   Mean   :0.17016   Mean   :0.14736   Mean   :0.111984   Mean   :0.18364
  3rd Qu.:0.4050   3rd Qu.:0.57309   3rd Qu.:0.55518   3rd Qu.:0.4369   3rd Qu.:0.30889   3rd Qu.:0.30373   3rd Qu.:0.30886   3rd Qu.:0.38098   3rd Qu.:0.32694   3rd Qu.:0.24610   3rd Qu.:0.23691   3rd Qu.:0.22714   3rd Qu.:0.21386   3rd Qu.:0.21554   3rd Qu.:0.179548   3rd Qu.:0.27244
  Max.   :0.4993   Max.   :0.94118   Max.   :0.80392   Max.   :0.9619   Max.   :0.69492   Max.   :0.47359   Max.   :0.68793   Max.   :0.70084   Max.   :0.68146   Max.   :0.57527   Max.   :0.31325   Max.   :0.38889   Max.   :0.40909   Max.   :0.40741   Max.   :0.272727   Max.   :0.62500
 [1] "-------------------------------------------------------------------------"
 [1] "work"
       0-4                5-9               10-14             15-19              20-24             25-29              30-34             35-39             40-44             45-49             50-54             55-59             60-64             65-69             70-74

  Min.   :0.000000   Min.   :0.000000   Min.   :0.00000   Min.   :0.000000   Min.   :0.00000   Min.   :0.006953   Min.   :0.00000   Min.   :0.01619   Min.   :0.02335   Min.   :0.00000   Min.   :0.00000   Min.   :0.00000   Min.   :0.00000   Min.   :0.00000   Min.   :0.000000   Min.   :0.000000
  1st Qu.:0.000000   1st Qu.:0.000000   1st Qu.:0.00000   1st Qu.:0.007676   1st Qu.:0.04926   1st Qu.:0.093358   1st Qu.:0.03803   1st Qu.:0.10946   1st Qu.:0.04798   1st Qu.:0.09051   1st Qu.:0.05703   1st Qu.:0.03008   1st Qu.:0.01406   1st Qu.:0.00000   1st Qu.:0.000000   1st Qu.:0.000000
  Median :0.000000   Median :0.009307   Median :0.00920   Median :0.058526   Median :0.15692   Median :0.194046   Median :0.15411   Median :0.20479   Median :0.17892   Median :0.21845   Median :0.11323   Median :0.13525   Median :0.04557   Median :0.04114   Median :0.006548   Median :0.002381
  Mean   :0.015903   Mean   :0.042219   Mean   :0.02083   Mean   :0.094666   Mean   :0.16089   Mean   :0.236826   Mean   :0.19564   Mean   :0.22977   Mean   :0.22198   Mean   :0.27043   Mean   :0.12480   Mean   :0.12076   Mean   :0.06549   Mean   :0.03224   Mean   :0.014003   Mean   :0.016386
  3rd Qu.:0.008671   3rd Qu.:0.049204   3rd Qu.:0.01907   3rd Qu.:0.158738   3rd Qu.:0.26026   3rd Qu.:0.381874   3rd Qu.:0.36794   3rd Qu.:0.37314   3rd Qu.:0.34436   3rd Qu.:0.42546   3rd Qu.:0.19197   3rd Qu.:0.20630   3rd Qu.:0.10810   3rd Qu.:0.05354   3rd Qu.:0.029493   3rd Qu.:0.018506
  Max.   :0.121429   Max.   :0.185714   Max.   :0.17273   Max.   :0.361905   Max.   :0.40678   Max.   :0.573534   Max.   :0.49164   Max.   :0.53276   Max.   :0.56452   Max.   :0.72727   Max.   :0.29591   Max.   :0.23231   Max.   :0.21302   Max.   :0.07863   Max.   :0.045455   Max.   :0.118182
 [1] "-------------------------------------------------------------------------"
 [1] "school"
       0-4                5-9              10-14             15-19             20-24              25-29             30-34             35-39             40-44             45-49             50-54              55-59              60-64              65-69              70-74

  Min.   :0.000000   Min.   :0.00000   Min.   :0.00000   Min.   :0.00000   Min.   :0.000000   Min.   :0.00000   Min.   :0.00000   Min.   :0.00000   Min.   :0.00000   Min.   :0.00000   Min.   :0.000000   Min.   :0.000000   Min.   :0.000000   Min.   :0.000000   Min.   :0.000000   Min.   :0.000000
  1st Qu.:0.008528   1st Qu.:0.04234   1st Qu.:0.02211   1st Qu.:0.02790   1st Qu.:0.007859   1st Qu.:0.00000   1st Qu.:0.02199   1st Qu.:0.02089   1st Qu.:0.02066   1st Qu.:0.01483   1st Qu.:0.000000   1st Qu.:0.007468   1st Qu.:0.000000   1st Qu.:0.000000   1st Qu.:0.000000   1st Qu.:0.000000
  Median :0.024145   Median :0.09194   Median :0.06640   Median :0.05430   Median :0.012839   Median :0.02570   Median :0.04116   Median :0.05501   Median :0.04768   Median :0.02654   Median :0.003967   Median :0.009470   Median :0.009664   Median :0.002632   Median :0.000000   Median :0.000000
  Mean   :0.112839   Mean   :0.41307   Mean   :0.40616   Mean   :0.30059   Mean   :0.052988   Mean   :0.04336   Mean   :0.05077   Mean   :0.06919   Mean   :0.05170   Mean   :0.03556   Mean   :0.020361   Mean   :0.018743   Mean   :0.017827   Mean   :0.011193   Mean   :0.002846   Mean   :0.000504
  3rd Qu.:0.087690   3rd Qu.:0.14577   3rd Qu.:0.18155   3rd Qu.:0.09666   3rd Qu.:0.034847   3rd Qu.:0.07518   3rd Qu.:0.07962   3rd Qu.:0.09134   3rd Qu.:0.06546   3rd Qu.:0.03676   3rd Qu.:0.036908   3rd Qu.:0.034259   3rd Qu.:0.015812   3rd Qu.:0.024143   3rd Qu.:0.000000   3rd Qu.:0.000000
  Max.   :1.178947   Max.   :5.07843   Max.   :4.87255   Max.   :3.64762   Max.   :0.457627   Max.   :0.11905   Max.   :0.15687   Max.   :0.24145   Max.   :0.17700   Max.   :0.11939   Max.   :0.078431   Max.   :0.054420   Max.   :0.088104   Max.   :0.043057   Max.   :0.040281   Max.   :0.008065
 [1] "-------------------------------------------------------------------------"
 [1] "other"
       0-4                5-9              10-14             15-19              20-24             25-29             30-34            35-39            40-44            45-49             50-54            55-59             60-64             65-69             70-74

  Min.   :0.003734   Min.   :0.01838   Min.   :0.02743   Min.   :0.006333   Min.   :0.03214   Min.   :0.07838   Min.   :0.1021   Min.   :0.1127   Min.   :0.1316   Min.   :0.04211   Min.   :0.1029   Min.   :0.06784   Min.   :0.05326   Min.   :0.03591   Min.   :0.03746   Min.   :0.005263
  1st Qu.:0.068520   1st Qu.:0.07807   1st Qu.:0.07448   1st Qu.:0.087384   1st Qu.:0.18017   1st Qu.:0.19131   1st Qu.:0.1770   1st Qu.:0.2123   1st Qu.:0.2214   1st Qu.:0.15844   1st Qu.:0.2263   1st Qu.:0.09159   1st Qu.:0.14142   1st Qu.:0.10682   1st Qu.:0.08358   1st Qu.:0.041584
  Median :0.117469   Median :0.12445   Median :0.12179   Median :0.171740   Median :0.21659   Median :0.25651   Median :0.2330   Median :0.2771   Median :0.2797   Median :0.20970   Median :0.3227   Median :0.23708   Median :0.20947   Median :0.16465   Median :0.15730   Median :0.131614
  Mean   :0.123138   Mean   :0.16894   Mean   :0.19769   Mean   :0.271905   Mean   :0.29216   Mean   :0.30281   Mean   :0.2674   Mean   :0.2795   Mean   :0.2858   Mean   :0.24544   Mean   :0.3068   Mean   :0.24723   Mean   :0.20887   Mean   :0.18300   Mean   :0.16215   Mean   :0.183660
  3rd Qu.:0.177872   3rd Qu.:0.18420   3rd Qu.:0.15691   3rd Qu.:0.213914   3rd Qu.:0.30376   3rd Qu.:0.33748   3rd Qu.:0.3518   3rd Qu.:0.3338   3rd Qu.:0.3213   3rd Qu.:0.32408   3rd Qu.:0.3965   3rd Qu.:0.34283   3rd Qu.:0.26548   3rd Qu.:0.25302   3rd Qu.:0.21422   3rd Qu.:0.246897
  Max.   :0.294737   Max.   :0.75490   Max.   :1.27451   Max.   :1.828571   Max.   :1.03390   Max.   :0.81356   Max.   :0.6167   Max.   :0.4438   Max.   :0.4864   Max.   :0.56364   Max.   :0.4799   Max.   :0.57407   Max.   :0.42775   Max.   :0.34672   Max.   :0.33193   Max.   :0.642539
 [1] "-------------------------------------------------------------------------"
</pre>
</div></li>
</ul>

<p>
Values greater than 1:
</p>
<div class="org-src-container">
<pre class="src src-org">home:
max = 0.961904761904762

work:
max = 0.727272727272727

school:
i         j         value
<span style="color: #84888b;">-------------------------------------</span>
0-4       0-4       1.17894736842105
5-9       5-9       5.07843137254902
10-14     10-14     4.87254901960784
15-19     15-19     3.64761904761905


other:
i         j         value
<span style="color: #84888b;">-------------------------------------</span>
10-14     10-14     1.27450980392157
15-19     15-19     1.82857142857143
20-24     20-24     1.03389830508475
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5921cdb" class="outline-2">
<h2 id="org5921cdb"><span class="section-number-2">5</span> UK Regions</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org2a979c8" class="outline-3">
<h3 id="org2a979c8"><span class="section-number-3">5.1</span> Regional parameter setup</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Set up regional parameters, down to county level (level = 3)
</p>
<div class="org-src-container">
<pre class="src src-R">locations = cm_uk_locations(<span style="color: #50a14f;">"UK"</span>, <span style="color: #da8548; font-weight: bold;">3</span>);
parameters = cm_parameters_SEI3R(locations, date_start = <span style="color: #50a14f;">"2020-01-29"</span>, date_end = <span style="color: #50a14f;">"2021-12-31"</span>,
    dE  = cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">4.0</span>, <span style="color: #da8548; font-weight: bold;">4.0</span>, t_max = <span style="color: #da8548; font-weight: bold;">60</span>, t_step = <span style="color: #da8548; font-weight: bold;">0.25</span>)$p, <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">6.5 day serial interval.</span>
    dIp = cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">1.5</span>, <span style="color: #da8548; font-weight: bold;">4.0</span>, t_max = <span style="color: #da8548; font-weight: bold;">60</span>, t_step = <span style="color: #da8548; font-weight: bold;">0.25</span>)$p, <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">1.5 days w/o symptoms</span>
    dIs = cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">3.5</span>, <span style="color: #da8548; font-weight: bold;">4.0</span>, t_max = <span style="color: #da8548; font-weight: bold;">60</span>, t_step = <span style="color: #da8548; font-weight: bold;">0.25</span>)$p, <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">5 days total of infectiousness</span>
    dIa = cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">5.0</span>, <span style="color: #da8548; font-weight: bold;">4.0</span>, t_max = <span style="color: #da8548; font-weight: bold;">60</span>, t_step = <span style="color: #da8548; font-weight: bold;">0.25</span>)$p, <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">5 days total of infectiousness here as well.</span>
    deterministic = F);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">print_params(parameters, <span style="color: #da8548; font-weight: bold;">10</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Duration fields:
 date0 : 2020-01-29
 time0 : 0
 time1 : 2021-12-31
 time_step : 0.25


Behavioural flag fields
 fast_multinomial : NA
 deterministric : NA


Populations [186]:
UK | County Durham
UK | Darlington
UK | Hartlepool
UK | Middlesbrough
UK | Northumberland
UK | Redcar and Cleveland
UK | Stockton-on-Tees
UK | Tyne and Wear (Met County)
UK | Blackburn with Darwen
UK | Blackpool ...
</pre>
</div>

<p>
186 populations (one for each region at level 3).
</p>

<p>
Fields for first population:
</p>
<div class="org-src-container">
<pre class="src src-org">  type           : chr "SEI3R"
  dE             : num [1:241] 9.21e-06 6.02e-04 3.27e-03 8.38e-03 1.54e-02 ...
  dIp            : num [1:241] 0.000395 0.018594 0.069279 0.119197 0.145304 ...
  dIa            : num [1:241] 3.85e-06 2.62e-04 1.49e-03 4.00e-03 7.71e-03 ...
  dIs            : num [1:241] 1.55e-05 9.85e-04 5.17e-03 1.28e-02 2.27e-02 ...
  dH             : num 1
  dC             : num 1
  size           : num [1:16] 27021 29989 28558 29134 35874 ...
  matrices       :List of 4
  contact        : num [1:4] 1 1 1 1
  contact_mult   : num(0)
  contact_lowerto: num(0)
  u              : num [1:16] 0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.08 ...
  y              : num [1:16] 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 ...
  fIp            : num [1:16] 1 1 1 1 1 1 1 1 1 1 ...
  fIs            : num [1:16] 1 1 1 1 1 1 1 1 1 1 ...
  fIa            : num [1:16] 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 ...
  rho            : num [1:16] 1 1 1 1 1 1 1 1 1 1 ...
  tau            : num [1:16] 1 1 1 1 1 1 1 1 1 1 ...
  seed_times     : num 1
  dist_seed_ages : num [1:16] 1 1 1 1 1 1 1 1 1 1 ...
  schedule       : list()
  observer       : NULL
  name           : chr "UK | County Durham"
  group_names    : chr [1:16] "0-4" "5-9" "10-14" "15-19" ...
</pre>
</div>

<p>
Matrices for first population:
</p>

<div class="figure">
<p><img src="2-home-parameters.png" alt="2-home-parameters.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org7aaadfb" class="outline-3">
<h3 id="org7aaadfb"><span class="section-number-3">5.2</span> Split matrices.</h3>
<div class="outline-text-3" id="text-5-2">
<p>
Second parameter is bounds, set to index of &ldquo;70-74&rdquo;. Two
matrices formed from contact values of &ldquo;70-74&rdquo; and above (inclusive), and
&ldquo;65-69&rdquo; and below. This is done for every population.
Only contact matrices are affected.
</p>
<div class="org-src-container">
<pre class="src src-R">parameters = cm_split_matrices_ex_in(parameters, <span style="color: #da8548; font-weight: bold;">15</span>);
</pre>
</div>

<p>
Matrices for first population again:
</p>

<div class="figure">
<p><img src="3-home-parameters-after-split.png" alt="3-home-parameters-after-split.png" />
</p>
</div>

<p>
For each population (i.e. region), we add a new matrix &ldquo;gran&rdquo;,
for child-grandparent contacts.
</p>

<p>
<code>mat_ref</code> is formed from total of home, other, home2 and other2 (essentially total
of home and other, for all ages).
</p>

<p>
This only does anything for analysis = 4.
Otherwise, it&rsquo;s an matrix of zeros.
</p>

<p>
For analysis for, it assumes that all (or a constant portion) of the time of
grandparents is spent with children.
</p>

<p>
For age 0-4, grandparents are everyone above 55
For age 5-9, grandparents are everyone above 60
For age 10-14, grandparents are everyone above 65
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">Create child-elderly contacts</span>

<span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">Create additional matrix for child-elderly contacts</span>
<span style="color: #e45649;">for</span> (j <span style="color: #e45649;">in</span> seq_along(parameters$pop))
{
  <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">Recover home/other contact matrix</span>
  mat_ref <span style="color: #b751b6;">&lt;-</span> parameters$pop[[j]]$matrices[[<span style="color: #da8548; font-weight: bold;">1</span>]] + parameters$pop[[j]]$matrices[[<span style="color: #da8548; font-weight: bold;">4</span>]] +
    parameters$pop[[j]]$matrices[[<span style="color: #da8548; font-weight: bold;">5</span>]] + parameters$pop[[j]]$matrices[[<span style="color: #da8548; font-weight: bold;">8</span>]]

  gran <span style="color: #b751b6;">&lt;-</span> <span style="color: #da8548; font-weight: bold;">5</span> / <span style="color: #da8548; font-weight: bold;">7</span> <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">adjustment for weekdays only.</span>
  N <span style="color: #b751b6;">&lt;-</span> nrow(mat_ref)
  popsize <span style="color: #b751b6;">&lt;-</span> parameters$pop[[j]]$size
  mat <span style="color: #b751b6;">&lt;-</span> matrix(<span style="color: #da8548; font-weight: bold;">0</span>, ncol = N, nrow = N)

  <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">Add child-grandparent contacts: under 15s to 55+s</span>
  <span style="color: #e45649;">if</span> (analysis == <span style="color: #da8548; font-weight: bold;">4</span>) {
    <span style="color: #e45649;">for</span> (a <span style="color: #e45649;">in</span> <span style="color: #da8548; font-weight: bold;">1</span>:<span style="color: #da8548; font-weight: bold;">3</span>) {
      <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">pick out only contact between above 55, then 60, then 64 and child</span>
      dist <span style="color: #b751b6;">&lt;-</span> c(rep(<span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">10</span> + a), mat_ref[a, (<span style="color: #da8548; font-weight: bold;">11</span> + a):N])
      <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">re-normalise (total = 1)</span>
      dist <span style="color: #b751b6;">&lt;-</span> dist / sum(dist)
      mat[a, ] <span style="color: #b751b6;">&lt;-</span> mat[a, ] + gran * dist
      mat[, a] <span style="color: #b751b6;">&lt;-</span> mat[, a] + (gran * dist) * (popsize[a] / popsize)
    }
  }

  <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">Add child-grandparent contact matrix to population</span>
  parameters$pop[[j]]$matrices$gran <span style="color: #b751b6;">&lt;-</span> mat
  parameters$pop[[j]]$contact <span style="color: #b751b6;">&lt;-</span> c(parameters$pop[[j]]$contact, <span style="color: #da8548; font-weight: bold;">0</span>)
}
</pre>
</div>

<p>
For entry #4 the gran matrix looks like this:
This is related to dist of contact of 
</p>


<div class="figure">
<p><img src="1-home-parameters-after-split-and-gran.png" alt="1-home-parameters-after-split-and-gran.png" />
</p>
</div>


<div class="figure">
<p><img src="1-home-parameters-after-split-and-gran.png" alt="1-home-parameters-after-split-and-gran.png" />
</p>
</div>

<p>
Read probs variable. I presume this to be the probability of individuals in
various age ranges who contract (?) the virus of being in various states
relevant to the health system.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">Health burden processes</span>
probs = fread(
<span style="color: #50a14f;">"Age,Prop_symptomatic,IFR,Prop_inf_hosp,Prop_inf_critical,Prop_critical_fatal,Prop_noncritical_fatal,Prop_symp_hospitalised,Prop_hospitalised_critical</span>
<span style="color: #50a14f;">10,0.66,8.59E-05,0.002361009,6.44E-05,0.5,0,0,0.3</span>
<span style="color: #50a14f;">20,0.66,0.000122561,0.003370421,9.19E-05,0.5,9.47E-04,0.007615301,0.3</span>
<span style="color: #50a14f;">30,0.66,0.000382331,0.010514103,0.000286748,0.5,0.001005803,0.008086654,0.3</span>
<span style="color: #50a14f;">40,0.66,0.000851765,0.023423527,0.000638823,0.5,0.001231579,0.009901895,0.3</span>
<span style="color: #50a14f;">50,0.66,0.001489873,0.0394717,0.001117404,0.5,0.002305449,0.018535807,0.3</span>
<span style="color: #50a14f;">60,0.66,0.006933589,0.098113786,0.005200192,0.5,0.006754596,0.054306954,0.3</span>
<span style="color: #50a14f;">70,0.66,0.022120421,0.224965092,0.016590316,0.5,0.018720727,0.150514645,0.3</span>
<span style="color: #50a14f;">80,0.66,0.059223786,0.362002579,0.04441784,0.5,0.041408882,0.332927412,0.3</span>
<span style="color: #50a14f;">100,0.66,0.087585558,0.437927788,0.065689168,0.5,0.076818182,0.617618182,0.3"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">10  0.66    8.59e-05    0.002361009 6.44e-05    0.5 0   0   0.3
20  0.66    0.000122561 0.003370421 9.19e-05    0.5 0.000947    0.007615301 0.3
30  0.66    0.000382331 0.010514103 0.000286748 0.5 0.001005803 0.008086654 0.3
40  0.66    0.000851765 0.023423527 0.000638823 0.5 0.001231579 0.009901895 0.3
50  0.66    0.001489873 0.0394717   0.001117404 0.5 0.002305449 0.018535807 0.3
60  0.66    0.006933589 0.098113786 0.005200192 0.5 0.006754596 0.054306954 0.3
70  0.66    0.022120421 0.224965092 0.016590316 0.5 0.018720727 0.150514645 0.3
80  0.66    0.059223786 0.362002579 0.04441784  0.5 0.041408882 0.332927412 0.3
100 0.66    0.087585558 0.437927788 0.065689168 0.5 0.076818182 0.617618182 0.3
</pre>
</div>

<p>
Names
</p>
<div class="org-src-container">
<pre class="src src-R">probs
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">   Age Prop_symptomatic         IFR Prop_inf_hosp Prop_inf_critical Prop_critical_fatal Prop_noncritical_fatal Prop_symp_hospitalised Prop_hospitalised_critical
1:  10             0.66 0.000085900   0.002361009       0.000064400                 0.5            0.000000000            0.000000000                        0.3
2:  20             0.66 0.000122561   0.003370421       0.000091900                 0.5            0.000947000            0.007615301                        0.3
3:  30             0.66 0.000382331   0.010514103       0.000286748                 0.5            0.001005803            0.008086654                        0.3
4:  40             0.66 0.000851765   0.023423527       0.000638823                 0.5            0.001231579            0.009901895                        0.3
5:  50             0.66 0.001489873   0.039471700       0.001117404                 0.5            0.002305449            0.018535807                        0.3
6:  60             0.66 0.006933589   0.098113786       0.005200192                 0.5            0.006754596            0.054306954                        0.3
7:  70             0.66 0.022120421   0.224965092       0.016590316                 0.5            0.018720727            0.150514645                        0.3
8:  80             0.66 0.059223786   0.362002579       0.044417840                 0.5            0.041408882            0.332927412                        0.3
9: 100             0.66 0.087585558   0.437927788       0.065689168                 0.5            0.076818182            0.617618182                        0.3
</pre>
</div>


<p>
Reformat probabilities:
</p>
<div class="org-src-container">
<pre class="src src-R">
reformat = <span style="color: #e45649;">function</span>(P)
{
    <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">70-74,3388.488  75-79,2442.147  80-84,1736.567  85-89,1077.555  90-94,490.577  95-99,130.083  100+,15.834</span>
    x = c(P[<span style="color: #da8548; font-weight: bold;">1</span>:<span style="color: #da8548; font-weight: bold;">7</span>], weighted.mean(c(P[<span style="color: #da8548; font-weight: bold;">8</span>], P[<span style="color: #da8548; font-weight: bold;">9</span>]), c(<span style="color: #da8548; font-weight: bold;">3388.488</span> + <span style="color: #da8548; font-weight: bold;">2442.147</span>, <span style="color: #da8548; font-weight: bold;">1736.567</span> + <span style="color: #da8548; font-weight: bold;">1077.555</span> + <span style="color: #da8548; font-weight: bold;">490.577</span> + <span style="color: #da8548; font-weight: bold;">130.083</span> + <span style="color: #da8548; font-weight: bold;">15.834</span>)));
    <span style="color: #e45649;">return</span> (rep(x, each = <span style="color: #da8548; font-weight: bold;">2</span>))
}

P.icu_symp     = reformat(probs[, Prop_symp_hospitalised * Prop_hospitalised_critical]);
P.nonicu_symp  = reformat(probs[, Prop_symp_hospitalised * (<span style="color: #da8548; font-weight: bold;">1</span> - Prop_hospitalised_critical)]);
P.death_icu    = reformat(probs[, Prop_critical_fatal]);
P.death_nonicu = reformat(probs[, Prop_noncritical_fatal]);
hfr = probs[, Prop_noncritical_fatal / Prop_symp_hospitalised]


burden_processes = list(
    list(source = <span style="color: #50a14f;">"Ip"</span>, type = <span style="color: #50a14f;">"multinomial"</span>, names = c(<span style="color: #50a14f;">"to_icu"</span>, <span style="color: #50a14f;">"to_nonicu"</span>, <span style="color: #50a14f;">"null"</span>), report = c(<span style="color: #50a14f;">""</span>, <span style="color: #50a14f;">""</span>, <span style="color: #50a14f;">""</span>),
        prob = matrix(c(P.icu_symp, P.nonicu_symp, <span style="color: #da8548; font-weight: bold;">1</span> - P.icu_symp - P.nonicu_symp), nrow = <span style="color: #da8548; font-weight: bold;">3</span>, ncol = <span style="color: #da8548; font-weight: bold;">16</span>, byrow = T),
        delays = matrix(c(cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">7</span>, <span style="color: #da8548; font-weight: bold;">7</span>, <span style="color: #da8548; font-weight: bold;">60</span>, <span style="color: #da8548; font-weight: bold;">0.25</span>)$p, cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">7</span>, <span style="color: #da8548; font-weight: bold;">7</span>, <span style="color: #da8548; font-weight: bold;">60</span>, <span style="color: #da8548; font-weight: bold;">0.25</span>)$p, cm_delay_skip(<span style="color: #da8548; font-weight: bold;">60</span>, <span style="color: #da8548; font-weight: bold;">0.25</span>)$p), nrow = <span style="color: #da8548; font-weight: bold;">3</span>, byrow = T)),

    list(source = <span style="color: #50a14f;">"to_icu"</span>, type = <span style="color: #50a14f;">"multinomial"</span>, names = <span style="color: #50a14f;">"icu"</span>, report = <span style="color: #50a14f;">"p"</span>,
        prob = matrix(<span style="color: #da8548; font-weight: bold;">1</span>, nrow = <span style="color: #da8548; font-weight: bold;">1</span>, ncol = <span style="color: #da8548; font-weight: bold;">16</span>, byrow = T),
        delays = matrix(cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">10</span>, <span style="color: #da8548; font-weight: bold;">10</span>, <span style="color: #da8548; font-weight: bold;">60</span>, <span style="color: #da8548; font-weight: bold;">0.25</span>)$p, nrow = <span style="color: #da8548; font-weight: bold;">1</span>, byrow = T)),

    list(source = <span style="color: #50a14f;">"to_nonicu"</span>, type = <span style="color: #50a14f;">"multinomial"</span>, names = <span style="color: #50a14f;">"nonicu"</span>, report = <span style="color: #50a14f;">"p"</span>,
        prob = matrix(<span style="color: #da8548; font-weight: bold;">1</span>, nrow = <span style="color: #da8548; font-weight: bold;">1</span>, ncol = <span style="color: #da8548; font-weight: bold;">16</span>, byrow = T),
        delays = matrix(cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">8</span>, <span style="color: #da8548; font-weight: bold;">8</span>, <span style="color: #da8548; font-weight: bold;">60</span>, <span style="color: #da8548; font-weight: bold;">0.25</span>)$p, nrow = <span style="color: #da8548; font-weight: bold;">1</span>, byrow = T)),

    list(source = <span style="color: #50a14f;">"Ip"</span>, type = <span style="color: #50a14f;">"multinomial"</span>, names = c(<span style="color: #50a14f;">"death"</span>, <span style="color: #50a14f;">"null"</span>), report = c(<span style="color: #50a14f;">"o"</span>, <span style="color: #50a14f;">""</span>),
        prob = matrix(c(P.death_nonicu, <span style="color: #da8548; font-weight: bold;">1</span> - P.death_nonicu), nrow = <span style="color: #da8548; font-weight: bold;">2</span>, ncol = <span style="color: #da8548; font-weight: bold;">16</span>, byrow = T),
        delays = matrix(c(cm_delay_gamma(<span style="color: #da8548; font-weight: bold;">22</span>, <span style="color: #da8548; font-weight: bold;">22</span>, <span style="color: #da8548; font-weight: bold;">60</span>, <span style="color: #da8548; font-weight: bold;">0.25</span>)$p, cm_delay_skip(<span style="color: #da8548; font-weight: bold;">60</span>, <span style="color: #da8548; font-weight: bold;">0.25</span>)$p), nrow = <span style="color: #da8548; font-weight: bold;">2</span>, byrow = T))
)
parameters$processes = burden_processes
str(burden_processes)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">
List of 4
 $ :List of 6
  ..$ source: chr "Ip"
  ..$ type  : chr "multinomial"
  ..$ names : chr [1:3] "to_icu" "to_nonicu" "null"
  ..$ report: chr [1:3] "" "" ""
  ..$ prob  : num [1:3, 1:16] 0 0 1 0 0 ...
  ..$ delays: num [1:3, 1:241] 8.48e-11 8.48e-11 1.00 1.49e-07 1.49e-07 ...
 $ :List of 6
  ..$ source: chr "to_icu"
  ..$ type  : chr "multinomial"
  ..$ names : chr "icu"
  ..$ report: chr "p"
  ..$ prob  : num [1, 1:16] 1 1 1 1 1 1 1 1 1 1 ...
  ..$ delays: num [1, 1:241] 2.29e-16 1.08e-11 1.41e-09 3.14e-08 2.90e-07 ...
 $ :List of 6
  ..$ source: chr "to_nonicu"
  ..$ type  : chr "multinomial"
  ..$ names : chr "nonicu"
  ..$ report: chr "p"
  ..$ prob  : num [1, 1:16] 1 1 1 1 1 1 1 1 1 1 ...
  ..$ delays: num [1, 1:241] 1.32e-12 6.95e-09 3.25e-07 3.60e-06 1.96e-05 ...
 $ :List of 6
  ..$ source: chr "Ip"
  ..$ type  : chr "multinomial"
  ..$ names : chr [1:2] "death" "null"
  ..$ report: chr [1:2] "o" ""
  ..$ prob  : num [1:2, 1:16] 0 1 0 1 0.000947 ...
  ..$ delays: num [1:2, 1:241] 1.07e-41 1.00 2.64e-31 0.00 1.58e-26 ...
</pre>
</div>

<p>
Appear unused
</p>
<div class="org-src-container">
<pre class="src src-R">clt_i = <span style="color: #da8548; font-weight: bold;">1</span>;
clt_n = <span style="color: #da8548; font-weight: bold;">0</span>;
</pre>
</div>

<p>
Define observer lockdown triggers
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">Observer for lockdown scenarios</span>
observer_lockdown = <span style="color: #e45649;">function</span>(lockdown_trigger) <span style="color: #e45649;">function</span>(time, dynamics)
{
    <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">Get current icu prevalence</span>
    icu_prevalence = dynamics[t == time, sum(icu_p)];

    <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">Determine lockdown trigger</span>
    trigger = lockdown_trigger;

    <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">If ICU prevalence exceeds a threshold, turn on lockdown</span>
    <span style="color: #e45649;">if</span> (icu_prevalence &gt;= trigger) {
        <span style="color: #e45649;">return</span> (list(csv = paste(time, <span style="color: #50a14f;">"trace_lockdown"</span>, <span style="color: #50a14f;">"All"</span>, <span style="color: #da8548; font-weight: bold;">2</span>, sep = <span style="color: #50a14f;">","</span>),
            changes = list(contact_lowerto = c(<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0.1</span>, <span style="color: #da8548; font-weight: bold;">0.1</span>, <span style="color: #da8548; font-weight: bold;">0.1</span>,  <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0.1</span>, <span style="color: #da8548; font-weight: bold;">0.1</span>, <span style="color: #da8548; font-weight: bold;">0.1</span>,  <span style="color: #da8548; font-weight: bold;">1</span>))));
    } <span style="color: #e45649;">else</span>  {
        <span style="color: #e45649;">return</span> (list(csv = paste(time, <span style="color: #50a14f;">"trace_lockdown"</span>, <span style="color: #50a14f;">"All"</span>, <span style="color: #da8548; font-weight: bold;">1</span>, sep = <span style="color: #50a14f;">","</span>),
            changes = list(contact_lowerto = c(<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>))));
    }
    <span style="color: #e45649;">return</span> (list(csv = paste(time, <span style="color: #50a14f;">"trace_lockdown"</span>, <span style="color: #50a14f;">"All"</span>, <span style="color: #da8548; font-weight: bold;">1</span>, sep = <span style="color: #50a14f;">","</span>)))
}
</pre>
</div>

<p>
Not sure what this is. Pool for sampling initial condition?
</p>
<div class="org-src-container">
<pre class="src src-R">covid_scenario = qread(file.path(covid_uk_path, <span style="color: #50a14f;">"data/2-linelist_symp_fit_fIa0.5.qs"</span>));
str(covid_scenario)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">
Classes &#8216;data.table&#8217; and 'data.frame':  18000 obs. of  13 variables:
 $ trial: int  0 0 0 0 0 0 0 0 0 0 ...
 $ lp   : num  -2398 -2399 -2398 -2399 -2398 ...
 $ chain: int  0 1 2 3 4 5 6 7 8 9 ...
 $ ll   : num  -2393 -2394 -2393 -2395 -2393 ...
 $ f_00 : num  0.125 0.105 0.117 0.139 0.122 ...
 $ f_10 : num  0.073 0.0576 0.0661 0.0608 0.0669 ...
 $ f_20 : num  0.308 0.25 0.253 0.273 0.286 ...
 $ f_30 : num  0.419 0.362 0.395 0.424 0.42 ...
 $ f_40 : num  0.444 0.395 0.407 0.403 0.428 ...
 $ f_50 : num  0.527 0.46 0.484 0.523 0.522 ...
 $ f_60 : num  0.774 0.658 0.771 0.725 0.781 ...
 $ f_70 : num  0.733 0.632 0.664 0.707 0.708 ...
 $ size : num  49.4 47.3 53.1 55.4 45.5 ...
 <span style="color: #4078f2;">-</span> attr(*, ".internal.selfref")=&lt;
</pre>
</div>


<p>
Boolean flags for region/classification:
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">Identify London boroughs for early seeding, and regions of each country for time courses</span>
london = cm_structure_UK[match(str_sub(locations, <span style="color: #da8548; font-weight: bold;">6</span>), Name), Geography1 <span style="color: #b751b6;">%like%</span> <span style="color: #50a14f;">"London"</span>]
england = cm_structure_UK[match(str_sub(locations, <span style="color: #da8548; font-weight: bold;">6</span>), Name), Code <span style="color: #b751b6;">%like%</span> <span style="color: #50a14f;">"^E"</span> &amp; !(Geography1 <span style="color: #b751b6;">%like%</span> <span style="color: #50a14f;">"London"</span>)]
wales = cm_structure_UK[match(str_sub(locations, <span style="color: #da8548; font-weight: bold;">6</span>), Name), Code <span style="color: #b751b6;">%like%</span> <span style="color: #50a14f;">"^W"</span>]
scotland = cm_structure_UK[match(str_sub(locations, <span style="color: #da8548; font-weight: bold;">6</span>), Name), Code <span style="color: #b751b6;">%like%</span> <span style="color: #50a14f;">"^S"</span>]
nireland = cm_structure_UK[match(str_sub(locations, <span style="color: #da8548; font-weight: bold;">6</span>), Name), Code <span style="color: #b751b6;">%like%</span> <span style="color: #50a14f;">"^N"</span>]
westmid = cm_structure_UK[match(str_sub(locations, <span style="color: #da8548; font-weight: bold;">6</span>), Name), Name == <span style="color: #50a14f;">"West Midlands (Met County)"</span>]
cumbria = cm_structure_UK[match(str_sub(locations, <span style="color: #da8548; font-weight: bold;">6</span>), Name), Name == <span style="color: #50a14f;">"Cumbria"</span>]
</pre>
</div>

<p>
<code>cm_structure_UK</code> is read from a datafile (<code>"structure_UK.rds"</code>).
Boolean flags for classification are derived by pattern matching on the file.
The cm<sub>structure</sub><sub>UK</sub> is shown below. Presumably this is providing age distribution info.
</p>
<div class="org-src-container">
<pre class="src src-org">Classes &#8216;data.table&#8217; and 'data.frame':  430 obs. of  95 variables:
 $ Code      : chr  "K02000001" "K03000001" "K04000001" "E92000001" "E12000001" "E06000047" "E06000005" ...
 $ Name      : chr  "UNITED KINGDOM" "GREAT BRITAIN" "ENGLAND AND WALES" "ENGLAND" "NORTH EAST" "County Durham" "Darlington" ...
 $ Geography1: chr  "Country" "Country" "Country" "Country" "Region" "Unitary Authority" "Unitary Authority" ...
 $ All ages  : num  66435550 64553909 59115809 55977178 2657909 526980 106566 93242 140545 ...
 $ 0         : num  745263 722107 669797 637834 27275 4989 1134 999 1871 ...
 $ 1         : num  770614 746644 692792 659890 28355 5252 1104 1011 1970 ...
 $ 2         : num  796314 771397 715313 681032 29293 5448 1207 1101 1882 ...
 $ 3         : num  797183 772403 715338 680758 29138 5547 1216 1060 1969 ...
 $ 4         : num  804654 779741 722190 687213 30008 5785 1256 1126 1965 ...
 $ 5         : num  823204 797905 739193 703391 30795 5939 1314 1136 2025 ...
 $ 6         : num  848681 822531 762279 725210 31781 5929 1369 1200 1955 ...
 $ 7         : num  836008 810047 747953 710174 31880 6223 1284 1219 1975 ...
 $ 8         : num  819824 794129 734922 697777 31362 6140 1341 1218 1911 ...
 $ 9         : num  810807 784797 723973 687314 30492 5758 1342 1184 1740 ...
 $ 10        : num  816988 790978 730400 693071 31024 6065 1302 1182 1800 ...
 $ 11        : num  790130 765321 707081 671108 30014 5839 1284 1174 1741 ...
 $ 12        : num  774368 750726 693698 658113 30122 5801 1329 1148 1788 ...
 $ 13        : num  744924 721854 665305 630959 28377 5556 1225 1078 1636 ...
 $ 14        : num  732484 709693 654298 620868 27826 5297 1270 1018 1614 ...
 $ 15        : num  712733 690396 636635 603746 27256 5265 1203 1039 1521 ...
  [list output truncated]
 <span style="color: #4078f2;">-</span> attr(*, ".internal.selfref")=&lt;
</pre>
</div>

<p>
Columns for from 0-100.
</p>
</div>
</div>

<div id="outline-container-orgb7797d2" class="outline-3">
<h3 id="orgb7797d2"><span class="section-number-3">5.3</span> Aggregate function</h3>
<div class="outline-text-3" id="text-5-3">
</div>
<div id="outline-container-org4ae1cf6" class="outline-4">
<h4 id="org4ae1cf6"><span class="section-number-4">5.3.1</span> Collect functions</h4>
<div class="outline-text-4" id="text-5-3-1">
<p>
Two functions that are used later to aggregate results.
</p>

<div class="org-src-container">
<pre class="src src-R">add_totals = <span style="color: #e45649;">function</span>(run, totals)
{
    regions = run$dynamics[, unique(population)];

    <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">totals by age</span>
    totals0 = run$dynamics[, .(total = sum(value)), by = .(scenario, run, compartment, group)];
    <span style="color: #e45649;">return</span> (rbind(totals, totals0))
}

add_dynamics = <span style="color: #e45649;">function</span>(run, dynamics, iv)
{
    regions = run$dynamics[, unique(population)];

    interv = data.table(scenario = run$dynamics$scenario[<span style="color: #da8548; font-weight: bold;">1</span>], run = run$dynamics$run[<span style="color: #da8548; font-weight: bold;">1</span>], t = unique(run$dynamics$t),
        compartment = <span style="color: #50a14f;">"trace_school"</span>, region = <span style="color: #50a14f;">"All"</span>, value = unlist(iv$trace_school));
    <span style="color: #e45649;">if</span> (!is.null(iv$trace_intervention)) {
        interv = rbind(interv,
            data.table(scenario = run$dynamics$scenario[<span style="color: #da8548; font-weight: bold;">1</span>], run = run$dynamics$run[<span style="color: #da8548; font-weight: bold;">1</span>], t = unique(run$dynamics$t),
                compartment = <span style="color: #50a14f;">"trace_intervention"</span>, region = <span style="color: #50a14f;">"All"</span>, value = unlist(iv$trace_intervention)));
    } <span style="color: #e45649;">else</span> {
        interv = rbind(interv,
            data.table(scenario = run$dynamics$scenario[<span style="color: #da8548; font-weight: bold;">1</span>], run = run$dynamics$run[<span style="color: #da8548; font-weight: bold;">1</span>], t = unique(run$dynamics$t),
                compartment = <span style="color: #50a14f;">"trace_intervention"</span>, region = <span style="color: #50a14f;">"All"</span>, value = <span style="color: #da8548; font-weight: bold;">1</span>));
    }

    csvlines = <span style="color: #986801;">NULL</span>;
    <span style="color: #e45649;">if</span> (nchar(run$csv[[<span style="color: #da8548; font-weight: bold;">1</span>]]) &gt; <span style="color: #da8548; font-weight: bold;">0</span>) {
        csvlines = fread(run$csv[[<span style="color: #da8548; font-weight: bold;">1</span>]], header = F);
        csvlines = cbind(run$dynamics$scenario[<span style="color: #da8548; font-weight: bold;">1</span>], run$dynamics$run[<span style="color: #da8548; font-weight: bold;">1</span>], csvlines);
        names(csvlines) = c(<span style="color: #50a14f;">"scenario"</span>, <span style="color: #50a14f;">"run"</span>, <span style="color: #50a14f;">"t"</span>, <span style="color: #50a14f;">"compartment"</span>, <span style="color: #50a14f;">"region"</span>, <span style="color: #50a14f;">"value"</span>);
        csvlines = unique(csvlines);
    }

    <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">time courses</span>
    <span style="color: #e45649;">return</span> (rbind(dynamics,
        run$dynamics[population <span style="color: #b751b6;">%in%</span> locations[westmid],  .(region = <span style="color: #50a14f;">"West Midlands"</span>,    value = sum(value)), by = .(scenario, run, t, compartment)],
        run$dynamics[population <span style="color: #b751b6;">%in%</span> locations[cumbria],  .(region = <span style="color: #50a14f;">"Cumbria"</span>,          value = sum(value)), by = .(scenario, run, t, compartment)],
        run$dynamics[population <span style="color: #b751b6;">%in%</span> locations[london],   .(region = <span style="color: #50a14f;">"London"</span>,           value = sum(value)), by = .(scenario, run, t, compartment)],
        run$dynamics[population <span style="color: #b751b6;">%in%</span> locations[england],  .(region = <span style="color: #50a14f;">"England"</span>,          value = sum(value)), by = .(scenario, run, t, compartment)],
        run$dynamics[population <span style="color: #b751b6;">%in%</span> locations[wales],    .(region = <span style="color: #50a14f;">"Wales"</span>,            value = sum(value)), by = .(scenario, run, t, compartment)],
        run$dynamics[population <span style="color: #b751b6;">%in%</span> locations[scotland], .(region = <span style="color: #50a14f;">"Scotland"</span>,         value = sum(value)), by = .(scenario, run, t, compartment)],
        run$dynamics[population <span style="color: #b751b6;">%in%</span> locations[nireland], .(region = <span style="color: #50a14f;">"Northern Ireland"</span>, value = sum(value)), by = .(scenario, run, t, compartment)],
        run$dynamics[,                                    .(region = <span style="color: #50a14f;">"United Kingdom"</span>,   value = sum(value)), by = .(scenario, run, t, compartment)],
        interv,
        csvlines
    ))
}
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc52dfdf" class="outline-2">
<h2 id="orgc52dfdf"><span class="section-number-2">6</span> Main</h2>
<div class="outline-text-2" id="text-6">
<p>
Define school terms (base vs intervention)
</p>
<div class="org-src-container">
<pre class="src src-R">school_close_b =  c(<span style="color: #50a14f;">"2020-2-16"</span>, <span style="color: #50a14f;">"2020-4-05"</span>, <span style="color: #50a14f;">"2020-5-24"</span>, <span style="color: #50a14f;">"2020-7-22"</span>, <span style="color: #50a14f;">"2020-10-25"</span>, <span style="color: #50a14f;">"2020-12-20"</span>, <span style="color: #50a14f;">"2021-02-14"</span>, <span style="color: #50a14f;">"2021-04-01"</span>, <span style="color: #50a14f;">"2021-05-30"</span>, <span style="color: #50a14f;">"2021-07-25"</span>);
school_reopen_b = c(<span style="color: #50a14f;">"2020-2-22"</span>, <span style="color: #50a14f;">"2020-4-18"</span>, <span style="color: #50a14f;">"2020-5-30"</span>, <span style="color: #50a14f;">"2020-9-01"</span>, <span style="color: #50a14f;">"2020-10-31"</span>, <span style="color: #50a14f;">"2021-01-02"</span>, <span style="color: #50a14f;">"2021-02-20"</span>, <span style="color: #50a14f;">"2021-04-17"</span>, <span style="color: #50a14f;">"2021-06-05"</span>, <span style="color: #50a14f;">"2021-09-01"</span>);
school_close_i =  c(<span style="color: #50a14f;">"2020-2-16"</span>, <span style="color: #50a14f;">"2020-4-05"</span>, <span style="color: #50a14f;">"2020-5-24"</span>, <span style="color: #50a14f;">"2020-7-22"</span>, <span style="color: #50a14f;">"2020-10-25"</span>, <span style="color: #50a14f;">"2020-12-20"</span>, <span style="color: #50a14f;">"2021-02-14"</span>, <span style="color: #50a14f;">"2021-04-01"</span>, <span style="color: #50a14f;">"2021-05-30"</span>, <span style="color: #50a14f;">"2021-07-25"</span>);
school_reopen_i = c(<span style="color: #50a14f;">"2020-2-22"</span>, <span style="color: #50a14f;">"2020-4-18"</span>, <span style="color: #50a14f;">"2020-5-30"</span>, <span style="color: #50a14f;">"2020-9-01"</span>, <span style="color: #50a14f;">"2020-10-31"</span>, <span style="color: #50a14f;">"2021-01-02"</span>, <span style="color: #50a14f;">"2021-02-20"</span>, <span style="color: #50a14f;">"2021-04-17"</span>, <span style="color: #50a14f;">"2021-06-05"</span>, <span style="color: #50a14f;">"2021-09-01"</span>);
</pre>
</div>

<p>
Define some interventions, by their &ldquo;contact&rdquo;. There are 9 groups here.
</p>
<div class="org-src-container">
<pre class="src src-R">interventions = list(
    <span style="color: #383a42; background-color: #f0f0f0;">`School Closures`</span>   = list(contact = c(<span style="color: #da8548; font-weight: bold;">1.0</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>,  <span style="color: #da8548; font-weight: bold;">1.0</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>,  <span style="color: #da8548; font-weight: bold;">0</span>))
);
</pre>
</div>

<p>
Set the options
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">should the lockdown be triggered nationally (in one go) or locally by region</span>
option.trigger = <span style="color: #50a14f;">"national"</span>;

<span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">How long should the intervention last for?</span>
option.duration = <span style="color: #da8548; font-weight: bold;">7</span> * <span style="color: #da8548; font-weight: bold;">12</span>;

<span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">Is this a lockdown?</span>
option.lockdown = <span style="color: #986801;">NA</span>;

<span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">Allows to intervention wrt to computed peak of infection</span>
<span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">0 is centered at peak.</span>
option.intervention_shift = <span style="color: #da8548; font-weight: bold;">0</span>;
</pre>
</div>

<p>
Pick R0 from a normal distribution.
</p>
<div class="org-src-container">
<pre class="src src-R">set.seed(<span style="color: #da8548; font-weight: bold;">9876</span>);
R0s = rnorm(n_runs, mean = <span style="color: #da8548; font-weight: bold;">2.675739</span>, sd = <span style="color: #da8548; font-weight: bold;">0.5719293</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">3.26044660116393
2.01494818798272
2.56678063560151
2.62267317062699
2.68651581109931
</pre>
</div>

<p>
Set up some empty aggregate data structures
</p>
<div class="org-src-container">
<pre class="src src-R">dynamics = data.table()
totals = data.table()
print(Sys.time())
set.seed(<span style="color: #da8548; font-weight: bold;">1234567</span>);
</pre>
</div>

<p>
Seed again
</p>
<div class="org-src-container">
<pre class="src src-R">set.seed(<span style="color: #da8548; font-weight: bold;">1234567</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-org44625a1" class="outline-2">
<h2 id="org44625a1"><span class="section-number-2">7</span> Start Runs</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org5644f51" class="outline-3">
<h3 id="org5644f51"><span class="section-number-3">7.1</span> Base simulation</h3>
<div class="outline-text-3" id="text-7-1">
<p>
First thing is setup for a base simulation.
</p>

<p>
Set an R0 (this happens in the loop)
</p>
<div class="org-src-container">
<pre class="src src-R">r = R0s[<span style="color: #da8548; font-weight: bold;">1</span>]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">3.26044660116393
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">covid_scenario
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">       trial        lp chain        ll      f_00       f_10      f_20      f_30      f_40      f_50      f_60      f_70     size
    1:     0 -2397.630     0 -2392.980 0.1247845 0.07295634 0.3075943 0.4191281 0.4439132 0.5273762 0.7743843 0.7325784 49.40969
    2:     0 -2398.569     1 -2393.768 0.1051005 0.05757648 0.2498489 0.3619066 0.3948041 0.4599669 0.6578147 0.6319850 47.29300
    3:     0 -2397.795     2 -2392.965 0.1174401 0.06606591 0.2525465 0.3949755 0.4074855 0.4836499 0.7707342 0.6637128 53.07236
    4:     0 -2399.340     3 -2394.679 0.1391260 0.06079020 0.2734493 0.4237577 0.4026213 0.5227978 0.7247470 0.7069094 55.40430
    5:     0 -2397.630     4 -2392.885 0.1221617 0.06693948 0.2855716 0.4199246 0.4280588 0.5219734 0.7810006 0.7075087 45.52440
   ---
17996:   999 -2397.475    13 -2392.335 0.1570445 0.09094176 0.3294248 0.4943820 0.4901900 0.6161672 0.8954522 0.8188619 50.36484
17997:   999 -2399.101    14 -2394.203 0.1229701 0.05235644 0.2418619 0.3549702 0.3897229 0.4407649 0.6885768 0.6358008 56.79066
17998:   999 -2398.274    15 -2392.305 0.1672379 0.08747932 0.3686038 0.4616906 0.5003443 0.6532227 0.9553297 0.8344203 48.53948
17999:   999 -2399.586    16 -2395.207 0.1368256 0.07047143 0.3017713 0.3947725 0.4164846 0.5487908 0.7288546 0.6672768 43.46868
18000:   999 -2398.206    17 -2393.266 0.1318261 0.05292663 0.2455728 0.3296847 0.3494939 0.4654164 0.7121425 0.6454375 55.55304
</pre>
</div>

<p>
Unifromly sample a &ldquo;scenario&rdquo; (age-varying symptomatic rate, apparently).
This is just a row in the <code>covid_scenario</code> table, which was data.
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">1. Pick age-varying symptomatic rate</span>
covy = unname(unlist(covid_scenario[sample.int(nrow(covid_scenario), <span style="color: #da8548; font-weight: bold;">1</span>), f_00:f_70]));
covy = rep(covy, each = <span style="color: #da8548; font-weight: bold;">2</span>);
</pre>
</div>

<p>
Set UK scenario &ldquo;y&rdquo; to covy (avsr)
</p>
<div class="org-src-container">
<pre class="src src-R">parametersUK1$pop[[<span style="color: #da8548; font-weight: bold;">1</span>]]$y = covy;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">0.110365454000957
0.110365454000957
0.0658313431091681
0.0658313431091681
0.267296120911696
0.267296120911696
0.411541875601079
0.411541875601079
0.390821035209271
0.390821035209271
0.515082503370863
0.515082503370863
0.697017073733944
0.697017073733944
0.615829335365191
0.615829335365191
</pre>
</div>

<p>
Calculate an adjustment (a number)
</p>
<div class="org-src-container">
<pre class="src src-R">cm_calc_R0(parametersUK1, <span style="color: #da8548; font-weight: bold;">1</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">3.13591243385139
</pre>
</div>

<p>
Compute u<sub>adj</sub> (numeric)
</p>
<div class="org-src-container">
<pre class="src src-R">u_adj = r / cm_calc_R0(parametersUK1, <span style="color: #da8548; font-weight: bold;">1</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">1.0397122591716
</pre>
</div>

<p>
Pick seeding times
</p>
<div class="org-src-container">
<pre class="src src-R">seed_start = ifelse(london, sample(<span style="color: #da8548; font-weight: bold;">0</span>:<span style="color: #da8548; font-weight: bold;">6</span>, length(london), replace = T), sample(<span style="color: #da8548; font-weight: bold;">0</span>:<span style="color: #da8548; font-weight: bold;">20</span>, length(london), replace = T));
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"> int [1:186] 9 17 0 0 17 5 7 5 5 15 9 18 10 10 1 10 2 8 9 7 19 0 18 0 0 7 12 8 12 13 17 1 2 1 0 5 10 17 ...
</pre>
</div>

<p>
Set parameters (u<sub>adj</sub>, covy, <code>seed_times</code>). Compute <code>dist_seed_ages</code>
</p>
<div class="org-src-container">
<pre class="src src-R">    params = duplicate(parameters);
    <span style="color: #e45649;">for</span> (j <span style="color: #e45649;">in</span> seq_along(params$pop)) {
        params$pop[[j]]$u = params$pop[[j]]$u * u_adj;
        params$pop[[j]]$y = covy;
        params$pop[[j]]$seed_times = rep(seed_start[j] + <span style="color: #da8548; font-weight: bold;">0</span>:<span style="color: #da8548; font-weight: bold;">27</span>, each = <span style="color: #da8548; font-weight: bold;">2</span>);
        params$pop[[j]]$dist_seed_ages = cm_age_coefficients(<span style="color: #da8548; font-weight: bold;">25</span>, <span style="color: #da8548; font-weight: bold;">50</span>, <span style="color: #da8548; font-weight: bold;">5</span> * <span style="color: #da8548; font-weight: bold;">0</span>:<span style="color: #da8548; font-weight: bold;">16</span>);
    }
</pre>
</div>

<p>
Ages seed appears to be a constant
</p>
<div class="org-src-container">
<pre class="src src-R">params$pop[[<span style="color: #da8548; font-weight: bold;">1</span>]]$dist_seed_ages
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"> [1] 0 0 0 0 0 1 1 1 1 1 0 0 0 0 0 0
</pre>
</div>

<p>
Set school terms
</p>
<div class="org-src-container">
<pre class="src src-R">    <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">4b. Set school terms</span>
    iv = cm_iv_build(params)
    cm_iv_set(iv, school_close_b, school_reopen_b, contact = c(<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">1</span>,  <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">1</span>,  <span style="color: #da8548; font-weight: bold;">1</span>), trace_school = <span style="color: #da8548; font-weight: bold;">2</span>);
    params = cm_iv_apply(params, iv);
</pre>
</div>


<p>
Parameters for simulation:
</p>
<div class="org-src-container">
<pre class="src src-R">print_params(params, <span style="color: #da8548; font-weight: bold;">10</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Duration fields:
 date0 : 2020-01-29
 time0 : 0
 time1 : 2021-12-31
 time_step : 0.25


Behavioural flag fields
 fast_multinomial : NA
 deterministric : NA


Populations [186]:
UK | County Durham
UK | Darlington
UK | Hartlepool
UK | Middlesbrough
UK | Northumberland
UK | Redcar and Cleveland
UK | Stockton-on-Tees
UK | Tyne and Wear (Met County)
UK | Blackburn with Darwen
UK | Blackpool ...
</pre>
</div>

<p>
Population fields:
</p>
<div class="org-src-container">
<pre class="src src-R">print_population_fields(params)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">  time_step       : num 0.25
  date0           : chr "2020-01-29"
  time0           : num 0
  time1           : chr "2021-12-31"
  report_every    : num 4
  fast_multinomial: logi FALSE
  deterministic   : logi FALSE
  pop             :List of 186
  travel          : num [1:186, 1:186] 1 0 0 0 0 0 0 0 0 0 ...
  processes       :List of 4
</pre>
</div>

<p>
Contact Matrices:
</p>
<div class="org-src-container">
<pre class="src src-R">plot_matrices(params$pop[[<span style="color: #da8548; font-weight: bold;">1</span>]], c(<span style="color: #50a14f;">"gran"</span>, <span style="color: #50a14f;">"home"</span>, <span style="color: #50a14f;">"school"</span>, <span style="color: #50a14f;">"other"</span>, <span style="color: #50a14f;">"work"</span>))
</pre>
</div>


<div class="figure">
<p><img src="4-intervention-all.png" alt="4-intervention-all.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-R">plot_matrices(params$pop[[<span style="color: #da8548; font-weight: bold;">1</span>]], c(<span style="color: #50a14f;">"home2"</span>, <span style="color: #50a14f;">"school2"</span>, <span style="color: #50a14f;">"other2"</span>, <span style="color: #50a14f;">"work2"</span>))
</pre>
</div>


<div class="figure">
<p><img src="5-intervention-all.png" alt="5-intervention-all.png" />
</p>
</div>
</div>

<div id="outline-container-orgd375d0a" class="outline-4">
<h4 id="orgd375d0a"><span class="section-number-4">7.1.1</span> Run &ldquo;base&rdquo; simulation</h4>
<div class="outline-text-4" id="text-7-1-1">
<p>
Base simulation is run from parameters with a given <code>r</code>
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">run = cm_simulate(params, 1, r);</span>
<span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">run$dynamics[, run := r];</span>
<span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">run$dynamics[, scenario := "Base"];</span>
<span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">run$dynamics[, R0 := R0s[1]];</span>
</pre>
</div>

<p>
Simulation results contains 10 variables:
</p>
<div class="org-src-container">
<pre class="src src-org">base_parameters
dynamics
csv
changes
parameters_func
options
</pre>
</div>

<p>
<code>base_parameters</code> is a duplicate of the input parameters. The rest are:
</p>
<div class="org-src-container">
<pre class="src src-org">
List of 5
 $ dynamics       :Classes &#8216;data.table&#8217; and 'data.frame':   25105536 obs. of  6 variables:
  ..$ run        : int [1:25105536] 1 1 1 1 1 1 1 1 1 1 ...
  ..$ t          : num [1:25105536] 0 0 0 0 0 0 0 0 0 0 ...
  ..$ population : Factor w/ 186 levels "UK | County Durham",..: 1 1 1 1 1 1 1 1 1 1 ...
  ..$ group      : Factor w/ 16 levels "0-4","5-9","10-14",..: 1 2 3 4 5 6 7 8 9 10 ...
  ..$ compartment: Factor w/ 12 levels "S","E","Ip","Is",..: 1 1 1 1 1 1 1 1 1 1 ...
  ..$ value      : num [1:25105536] 27021 29989 28558 29134 35874 ...
  ..- attr(*, ".internal.selfref")=&lt;

  ..- attr(*, "index")= int(0)
 $ csv            :List of 1
  ..$ : chr ""
 $ changes        : NULL
 $ parameters_func: NULL
 $ options        :List of 2
  ..$ model_seed   : num 1
  ..$ model_version: num 1
 <span style="color: #4078f2;">-</span> attr(*, "class")= chr [1:2] "cm.run" "list"
</pre>
</div>

<p>
$dynamics$run is a constant (== 1)
$dynamics$t contains 35,712 consecutive entries for each t
Number of entries for each value of t (presumably # values per timestep)
This is the size of population * compartment * group
</p>

<p>
Summary of value field:
</p>
<div class="org-src-container">
<pre class="src src-org">   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      0       0       0    1865       0  227657
</pre>
</div>
</div>
</div>

<div id="outline-container-org6d8b8a7" class="outline-4">
<h4 id="org6d8b8a7"><span class="section-number-4">7.1.2</span> Interventions</h4>
<div class="outline-text-4" id="text-7-1-2">
<p>
For each different &ldquo;case&rdquo;, which could be an intervention and some parameters, a
simulation is set up and run.
</p>

<p>
First, setup. This is repetition of above.
The values from above are:
</p>
<div class="org-src-container">
<pre class="src src-R">trigger = <span style="color: #50a14f;">"national"</span>;
duration = <span style="color: #da8548; font-weight: bold;">7</span> * <span style="color: #da8548; font-weight: bold;">12</span>;
lockdown = <span style="color: #986801;">NA</span>;
intervention_shift = <span style="color: #da8548; font-weight: bold;">0</span>;
</pre>
</div>

<p>
Most of these can be a list, in which case multiple simulations are performed
(i.e. a parameter sweep).
</p>

<p>
Note the use of the same &ldquo;covy&rdquo; scenario, and the save R0 adjustment.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">5a. Make parameters and adjust R0</span>
params = duplicate(parameters);
<span style="color: #e45649;">for</span> (j <span style="color: #e45649;">in</span> seq_along(params$pop)) {
    params$pop[[j]]$u = params$pop[[j]]$u * u_adj;
    params$pop[[j]]$y = covy;
    <span style="color: #e45649;">if</span> (!is.na(lockdown)) {
        params$pop[[j]]$observer = observer_lockdown(lockdown);
    }
}
</pre>
</div>

<p>
In addition, there is a &ldquo;lockdown&rdquo; function that is added to &ldquo;observer&rdquo;.
</p>

<p>
This function closes around the trigger, and is called with
time and dynamics.
It returns a csv file and aset of &ldquo;changes&rdquo; in the form:
</p>

<div class="org-src-container">
<pre class="src src-R">list(contact_lowerto = c(<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0.1</span>, <span style="color: #da8548; font-weight: bold;">0.1</span>, <span style="color: #da8548; font-weight: bold;">0.1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0.1</span>, <span style="color: #da8548; font-weight: bold;">0.1</span>, <span style="color: #da8548; font-weight: bold;">0.1</span>, <span style="color: #da8548; font-weight: bold;">1</span>))
</pre>
</div>

<p>
if <code>icu_prevalence</code> triggers behaviour, otherwise:
</p>

<div class="org-src-container">
<pre class="src src-R">list(contact_lowerto = c(<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>))
</pre>
</div>

<p>
I presume this is a generic function made for tracing.
</p>

<p>
Set <code>intervention_start</code> from <code>peak_t</code> (computed from previous simulation)
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #e45649;">if</span> (trigger == <span style="color: #50a14f;">"national"</span>) {
    intervention_start = peak_t - duration / <span style="color: #da8548; font-weight: bold;">2</span> + intervention_shift;
} <span style="color: #e45649;">else</span> <span style="color: #e45649;">if</span> (trigger == <span style="color: #50a14f;">"local"</span>) {
    intervention_start = peak_t_bypop - duration / <span style="color: #da8548; font-weight: bold;">2</span> + intervention_shift;
} <span style="color: #e45649;">else</span> {
    intervention_start = as.numeric(ymd(trigger) - ymd(params$date0));
}
</pre>
</div>

<p>
<code>peak_t</code> is computed previously as:
</p>
<div class="org-src-container">
<pre class="src src-R">peak_t = run$dynamics[compartment == <span style="color: #50a14f;">"cases"</span>, .(total_cases = sum(value)), by = t][, t[which.max(total_cases)]];
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">70
</pre>
</div>

<p>
<code>peak_t_bypop</code> is computed previously as:
</p>
<div class="org-src-container">
<pre class="src src-R">peak_t_bypop = run$dynamics[compartment == <span style="color: #50a14f;">"cases"</span>, .(total_cases = sum(value)), by = .(t, population)][, t[which.max(total_cases)], by = population]$V1;
str(peak_t_bypop)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"> num [1:186] 64 72 61 56 75 68 75 70 76 64 ...
</pre>
</div>

<p>
Set the interventions. &ldquo;local&rdquo; means that all populations trigger lockdown
relative to their own peak of infection. Otherwise, trigger based on global <code>peak_t~</code>.
</p>

<p>
<code>cm_iv_set</code> sets a &ldquo;schedule&rdquo;, which passes the &ldquo;interventions&rdquo; vector into the
simulation as a &ldquo;schedule&rdquo;.
</p>

<p>
school close/open for both intervention and base case is treated as in the
same way as an &ldquo;intervention&rdquo;.
</p>

<p>
<code>trace_school</code> = 2 looks like it might be hooking into the same tracing mechanism
as the lockdown observer. Needs confirmation.
</p>

<p>
This code block sets a &ldquo;schedule&rdquo;. This is a list of entries (in this case 23) that each specify
a time step, and an intervention vector with 9 entries between 0 and 1. For
example:
</p>
<div class="org-src-container">
<pre class="src src-org">List of 3
 $ :List of 2
  ..$ t      : num 0
  ..$ contact: num [1:9] 1 1 1 1 1 1 1 1 1
 $ :List of 2
  ..$ t      : num 18
  ..$ contact: num [1:9] 1 1 0 1 1 1 0 1 1
 $ :List of 2
  ..$ t      : num 25
  ..$ contact: num [1:9] 1 1 1 1 1 1 1 1 1
</pre>
</div>

<p>
Not sure what &ldquo;contact&rdquo; is. Contagiousness maybe? Or related to infection state? Indexed from the end or the
start? (9 entries and 16 age bands, 12 compartments).
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orga56acdd" class="outline-2">
<h2 id="orga56acdd"><span class="section-number-2">8</span> Appendix</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org25b14fe" class="outline-3">
<h3 id="org25b14fe"><span class="section-number-3">8.1</span> Regions/Locations</h3>
<div class="outline-text-3" id="text-8-1">
</div>
<div id="outline-container-orgcce0198" class="outline-4">
<h4 id="orgcce0198"><span class="section-number-4">8.1.1</span> level 0</h4>
<div class="outline-text-4" id="text-8-1-1">
<p>
Look for regions with different level/granularity:
</p>
<div class="org-src-container">
<pre class="src src-R">cm_uk_locations(<span style="color: #50a14f;">"UK"</span>, <span style="color: #da8548; font-weight: bold;">0</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">[1] "UK | UNITED KINGDOM"
</pre>
</div>

<p>
In this case, since &ldquo;level&rdquo; is zero, only fetch UK region.
</p>

<p>
We can do the same thing for regions of the UK at level 2
</p>
</div>
</div>
<div id="outline-container-org69b5507" class="outline-4">
<h4 id="org69b5507"><span class="section-number-4">8.1.2</span> level 1</h4>
<div class="outline-text-4" id="text-8-1-2">
<p>
Look for regions with different level/granularity:
</p>
<div class="org-src-container">
<pre class="src src-R">cm_uk_locations(<span style="color: #50a14f;">"UK"</span>, <span style="color: #da8548; font-weight: bold;">1</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">[1] "UK | ENGLAND"          "UK | WALES"            "UK | SCOTLAND"         "UK | NORTHERN IRELAND"
</pre>
</div>

<p>
Wales is here as an aggregate region.
</p>
</div>
</div>

<div id="outline-container-org8a56064" class="outline-4">
<h4 id="org8a56064"><span class="section-number-4">8.1.3</span> level 2</h4>
<div class="outline-text-4" id="text-8-1-3">
<div class="org-src-container">
<pre class="src src-R">locations = cm_uk_locations(<span style="color: #50a14f;">"UK"</span>, <span style="color: #da8548; font-weight: bold;">2</span>);
locations
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">UK | NORTH EAST
UK | NORTH WEST
UK | YORKSHIRE AND THE HUMBER
UK | EAST MIDLANDS
UK | WEST MIDLANDS
UK | EAST
UK | LONDON
UK | SOUTH EAST
UK | SOUTH WEST
UK | WALES
UK | SCOTLAND
UK | NORTHERN IRELAND
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc0b4ba8" class="outline-4">
<h4 id="orgc0b4ba8"><span class="section-number-4">8.1.4</span> level 3</h4>
<div class="outline-text-4" id="text-8-1-4">
<div class="org-src-container">
<pre class="src src-R">locations = cm_uk_locations(<span style="color: #50a14f;">"UK"</span>, <span style="color: #da8548; font-weight: bold;">3</span>);
locations
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">UK | County Durham
UK | Darlington
UK | Hartlepool
UK | Middlesbrough
UK | Northumberland
UK | Redcar and Cleveland
UK | Stockton-on-Tees
UK | Tyne and Wear (Met County)
UK | Blackburn with Darwen
UK | Blackpool
UK | Cheshire East
UK | Cheshire West and Chester
UK | Halton
UK | Warrington
UK | Cumbria
UK | Greater Manchester (Met County)
UK | Lancashire
UK | Merseyside (Met County)
UK | East Riding of Yorkshire
UK | Kingston upon Hull, City of
UK | North East Lincolnshire
UK | North Lincolnshire
UK | York
UK | North Yorkshire
UK | South Yorkshire (Met County)
UK | West Yorkshire (Met County)
UK | Derby
UK | Leicester
UK | Nottingham
UK | Rutland
UK | Derbyshire
UK | Leicestershire
UK | Lincolnshire
UK | Northamptonshire
UK | Nottinghamshire
UK | Herefordshire, County of
UK | Shropshire
UK | Stoke-on-Trent
UK | Telford and Wrekin
UK | Staffordshire
UK | Warwickshire
UK | West Midlands (Met County)
UK | Worcestershire
UK | Bedford
UK | Central Bedfordshire
UK | Luton
UK | Peterborough
UK | Southend-on-Sea
UK | Thurrock
UK | Cambridgeshire
UK | Essex
UK | Hertfordshire
UK | Norfolk
UK | Suffolk
UK | Camden
UK | City of London
UK | Hackney
UK | Hammersmith and Fulham
UK | Haringey
UK | Islington
UK | Kensington and Chelsea
UK | Lambeth
UK | Lewisham
UK | Newham
UK | Southwark
UK | Tower Hamlets
UK | Wandsworth
UK | Westminster
UK | Barking and Dagenham
UK | Barnet
UK | Bexley
UK | Brent
UK | Bromley
UK | Croydon
UK | Ealing
UK | Enfield
UK | Greenwich
UK | Harrow
UK | Havering
UK | Hillingdon
UK | Hounslow
UK | Kingston upon Thames
UK | Merton
UK | Redbridge
UK | Richmond upon Thames
UK | Sutton
UK | Waltham Forest
UK | Bracknell Forest
UK | Brighton and Hove
UK | Isle of Wight
UK | Medway
UK | Milton Keynes
UK | Portsmouth
UK | Reading
UK | Slough
UK | Southampton
UK | West Berkshire
UK | Windsor and Maidenhead
UK | Wokingham
UK | Buckinghamshire
UK | East Sussex
UK | Hampshire
UK | Kent
UK | Oxfordshire
UK | Surrey
UK | West Sussex
UK | Bath and North East Somerset
UK | Bournemouth, Christchurch and Poole
UK | Bristol, City of
UK | Cornwall
UK | Dorset
UK | Isles of Scilly
UK | North Somerset
UK | Plymouth
UK | South Gloucestershire
UK | Swindon
UK | Torbay
UK | Wiltshire
UK | Devon
UK | Gloucestershire
UK | Somerset
UK | Isle of Anglesey
UK | Gwynedd
UK | Conwy
UK | Denbighshire
UK | Flintshire
UK | Wrexham
UK | Powys
UK | Ceredigion
UK | Pembrokeshire
UK | Carmarthenshire
UK | Swansea
UK | Neath Port Talbot
UK | Bridgend
UK | Vale of Glamorgan
UK | Cardiff
UK | Rhondda Cynon Taf
UK | Merthyr Tydfil
UK | Caerphilly
UK | Blaenau Gwent
UK | Torfaen
UK | Monmouthshire
UK | Newport
UK | Aberdeen City
UK | Aberdeenshire
UK | Angus
UK | Argyll and Bute
UK | City of Edinburgh
UK | Clackmannanshire
UK | Dumfries and Galloway
UK | Dundee City
UK | East Ayrshire
UK | East Dunbartonshire
UK | East Lothian
UK | East Renfrewshire
UK | Falkirk
UK | Fife
UK | Glasgow City
UK | Highland
UK | Inverclyde
UK | Midlothian
UK | Moray
UK | Na h-Eileanan Siar
UK | North Ayrshire
UK | North Lanarkshire
UK | Orkney Islands
UK | Perth and Kinross
UK | Renfrewshire
UK | Scottish Borders
UK | Shetland Islands
UK | South Ayrshire
UK | South Lanarkshire
UK | Stirling
UK | West Dunbartonshire
UK | West Lothian
UK | Antrim and Newtownabbey
UK | Ards and North Down
UK | Armagh City, Banbridge and Craigavon
UK | Belfast
UK | Causeway Coast and Glens
UK | Derry City and Strabane
UK | Fermanagh and Omagh
UK | Lisburn and Castlereagh
UK | Mid and East Antrim
UK | Mid Ulster
UK | Newry, Mourne and Down
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeea4fe2" class="outline-4">
<h4 id="orgeea4fe2"><span class="section-number-4">8.1.5</span> level 4</h4>
<div class="outline-text-4" id="text-8-1-5">
<div class="org-src-container">
<pre class="src src-R">locations = cm_uk_locations(<span style="color: #50a14f;">"UK"</span>, <span style="color: #da8548; font-weight: bold;">4</span>);
locations
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">UK | County Durham
UK | Darlington
UK | Hartlepool
UK | Middlesbrough
UK | Northumberland
UK | Redcar and Cleveland
UK | Stockton-on-Tees
UK | Gateshead
UK | Newcastle upon Tyne
UK | North Tyneside
UK | South Tyneside
UK | Sunderland
UK | Blackburn with Darwen
UK | Blackpool
UK | Cheshire East
UK | Cheshire West and Chester
UK | Halton
UK | Warrington
UK | Allerdale
UK | Barrow-in-Furness
UK | Carlisle
UK | Copeland
UK | Eden
UK | South Lakeland
UK | Bolton
UK | Bury
UK | Manchester
UK | Oldham
UK | Rochdale
UK | Salford
UK | Stockport
UK | Tameside
UK | Trafford
UK | Wigan
UK | Burnley
UK | Chorley
UK | Fylde
UK | Hyndburn
UK | Lancaster
UK | Pendle
UK | Preston
UK | Ribble Valley
UK | Rossendale
UK | South Ribble
UK | West Lancashire
UK | Wyre
UK | Knowsley
UK | Liverpool
UK | Sefton
UK | St. Helens
UK | Wirral
UK | East Riding of Yorkshire
UK | Kingston upon Hull, City of
UK | North East Lincolnshire
UK | North Lincolnshire
UK | York
UK | Craven
UK | Hambleton
UK | Harrogate
UK | Richmondshire
UK | Ryedale
UK | Scarborough
UK | Selby
UK | Barnsley
UK | Doncaster
UK | Rotherham
UK | Sheffield
UK | Bradford
UK | Calderdale
UK | Kirklees
UK | Leeds
UK | Wakefield
UK | Derby
UK | Leicester
UK | Nottingham
UK | Rutland
UK | Amber Valley
UK | Bolsover
UK | Chesterfield
UK | Derbyshire Dales
UK | Erewash
UK | High Peak
UK | North East Derbyshire
UK | South Derbyshire
UK | Blaby
UK | Charnwood
UK | Harborough
UK | Hinckley and Bosworth
UK | Melton
UK | North West Leicestershire
UK | Oadby and Wigston
UK | Boston
UK | East Lindsey
UK | Lincoln
UK | North Kesteven
UK | South Holland
UK | South Kesteven
UK | West Lindsey
UK | Corby
UK | Daventry
UK | East Northamptonshire
UK | Kettering
UK | Northampton
UK | South Northamptonshire
UK | Wellingborough
UK | Ashfield
UK | Bassetlaw
UK | Broxtowe
UK | Gedling
UK | Mansfield
UK | Newark and Sherwood
UK | Rushcliffe
UK | Herefordshire, County of
UK | Shropshire
UK | Stoke-on-Trent
UK | Telford and Wrekin
UK | Cannock Chase
UK | East Staffordshire
UK | Lichfield
UK | Newcastle-under-Lyme
UK | South Staffordshire
UK | Stafford
UK | Staffordshire Moorlands
UK | Tamworth
UK | North Warwickshire
UK | Nuneaton and Bedworth
UK | Rugby
UK | Stratford-on-Avon
UK | Warwick
UK | Birmingham
UK | Coventry
UK | Dudley
UK | Sandwell
UK | Solihull
UK | Walsall
UK | Wolverhampton
UK | Bromsgrove
UK | Malvern Hills
UK | Redditch
UK | Worcester
UK | Wychavon
UK | Wyre Forest
UK | Bedford
UK | Central Bedfordshire
UK | Luton
UK | Peterborough
UK | Southend-on-Sea
UK | Thurrock
UK | Cambridge
UK | East Cambridgeshire
UK | Fenland
UK | Huntingdonshire
UK | South Cambridgeshire
UK | Basildon
UK | Braintree
UK | Brentwood
UK | Castle Point
UK | Chelmsford
UK | Colchester
UK | Epping Forest
UK | Harlow
UK | Maldon
UK | Rochford
UK | Tendring
UK | Uttlesford
UK | Broxbourne
UK | Dacorum
UK | East Hertfordshire
UK | Hertsmere
UK | North Hertfordshire
UK | St Albans
UK | Stevenage
UK | Three Rivers
UK | Watford
UK | Welwyn Hatfield
UK | Breckland
UK | Broadland
UK | Great Yarmouth
UK | King's Lynn and West Norfolk
UK | North Norfolk
UK | Norwich
UK | South Norfolk
UK | Babergh
UK | East Suffolk
UK | Ipswich
UK | Mid Suffolk
UK | West Suffolk
UK | Camden
UK | City of London
UK | Hackney
UK | Hammersmith and Fulham
UK | Haringey
UK | Islington
UK | Kensington and Chelsea
UK | Lambeth
UK | Lewisham
UK | Newham
UK | Southwark
UK | Tower Hamlets
UK | Wandsworth
UK | Westminster
UK | Barking and Dagenham
UK | Barnet
UK | Bexley
UK | Brent
UK | Bromley
UK | Croydon
UK | Ealing
UK | Enfield
UK | Greenwich
UK | Harrow
UK | Havering
UK | Hillingdon
UK | Hounslow
UK | Kingston upon Thames
UK | Merton
UK | Redbridge
UK | Richmond upon Thames
UK | Sutton
UK | Waltham Forest
UK | Bracknell Forest
UK | Brighton and Hove
UK | Isle of Wight
UK | Medway
UK | Milton Keynes
UK | Portsmouth
UK | Reading
UK | Slough
UK | Southampton
UK | West Berkshire
UK | Windsor and Maidenhead
UK | Wokingham
UK | Aylesbury Vale
UK | Chiltern
UK | South Bucks
UK | Wycombe
UK | Eastbourne
UK | Hastings
UK | Lewes
UK | Rother
UK | Wealden
UK | Basingstoke and Deane
UK | East Hampshire
UK | Eastleigh
UK | Fareham
UK | Gosport
UK | Hart
UK | Havant
UK | New Forest
UK | Rushmoor
UK | Test Valley
UK | Winchester
UK | Ashford
UK | Canterbury
UK | Dartford
UK | Dover
UK | Folkestone and Hythe
UK | Gravesham
UK | Maidstone
UK | Sevenoaks
UK | Swale
UK | Thanet
UK | Tonbridge and Malling
UK | Tunbridge Wells
UK | Cherwell
UK | Oxford
UK | South Oxfordshire
UK | Vale of White Horse
UK | West Oxfordshire
UK | Elmbridge
UK | Epsom and Ewell
UK | Guildford
UK | Mole Valley
UK | Reigate and Banstead
UK | Runnymede
UK | Spelthorne
UK | Surrey Heath
UK | Tandridge
UK | Waverley
UK | Woking
UK | Adur
UK | Arun
UK | Chichester
UK | Crawley
UK | Horsham
UK | Mid Sussex
UK | Worthing
UK | Bath and North East Somerset
UK | Bournemouth, Christchurch and Poole
UK | Bristol, City of
UK | Cornwall
UK | Dorset
UK | Isles of Scilly
UK | North Somerset
UK | Plymouth
UK | South Gloucestershire
UK | Swindon
UK | Torbay
UK | Wiltshire
UK | East Devon
UK | Exeter
UK | Mid Devon
UK | North Devon
UK | South Hams
UK | Teignbridge
UK | Torridge
UK | West Devon
UK | Cheltenham
UK | Cotswold
UK | Forest of Dean
UK | Gloucester
UK | Stroud
UK | Tewkesbury
UK | Mendip
UK | Sedgemoor
UK | Somerset West and Taunton
UK | South Somerset
UK | Isle of Anglesey
UK | Gwynedd
UK | Conwy
UK | Denbighshire
UK | Flintshire
UK | Wrexham
UK | Powys
UK | Ceredigion
UK | Pembrokeshire
UK | Carmarthenshire
UK | Swansea
UK | Neath Port Talbot
UK | Bridgend
UK | Vale of Glamorgan
UK | Cardiff
UK | Rhondda Cynon Taf
UK | Merthyr Tydfil
UK | Caerphilly
UK | Blaenau Gwent
UK | Torfaen
UK | Monmouthshire
UK | Newport
UK | Aberdeen City
UK | Aberdeenshire
UK | Angus
UK | Argyll and Bute
UK | City of Edinburgh
UK | Clackmannanshire
UK | Dumfries and Galloway
UK | Dundee City
UK | East Ayrshire
UK | East Dunbartonshire
UK | East Lothian
UK | East Renfrewshire
UK | Falkirk
UK | Fife
UK | Glasgow City
UK | Highland
UK | Inverclyde
UK | Midlothian
UK | Moray
UK | Na h-Eileanan Siar
UK | North Ayrshire
UK | North Lanarkshire
UK | Orkney Islands
UK | Perth and Kinross
UK | Renfrewshire
UK | Scottish Borders
UK | Shetland Islands
UK | South Ayrshire
UK | South Lanarkshire
UK | Stirling
UK | West Dunbartonshire
UK | West Lothian
UK | Antrim and Newtownabbey
UK | Ards and North Down
UK | Armagh City, Banbridge and Craigavon
UK | Belfast
UK | Causeway Coast and Glens
UK | Derry City and Strabane
UK | Fermanagh and Omagh
UK | Lisburn and Castlereagh
UK | Mid and East Antrim
UK | Mid Ulster
UK | Newry, Mourne and Down
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: mark</p>
<p class="date">Created: 2020-05-22 Fri 21:03</p>
</div>
</body>
</html>
